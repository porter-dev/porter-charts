{{- if and (not .Values.bluegreen.enabled) .Values.keda.enabled -}}
{{- $fullName := include "docker-template.fullname" $ -}}
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ $fullName }} 
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ $fullName }}
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  minReplicaCount: {{ .Values.keda.minReplicaCount }}
  maxReplicaCount: {{ .Values.keda.maxReplicaCount }}
  {{- if and .Values.keda.fallback .Values.keda.fallback.enabled }}
  fallback:
    failureThreshold: {{ .Values.keda.fallback.failureThreshold }}
    replicas: {{ .Values.keda.fallback.failureReplicas }}
  {{- end }}
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      behavior:
        scaleUp:
          stabilizationWindowSeconds: {{ .Values.keda.hpa.scaleUp.stabilizationWindowSeconds }}
          policies:
          - type: {{ .Values.keda.hpa.scaleUp.policy.type }}
            value: {{ .Values.keda.hpa.scaleUp.policy.value }}
            periodSeconds: {{ .Values.keda.hpa.scaleUp.policy.periodSeconds }}
        scaleDown:
          stabilizationWindowSeconds: {{ .Values.keda.hpa.scaleDown.stabilizationWindowSeconds }}
          policies:
          - type: {{ .Values.keda.hpa.scaleDown.policy.type }}
            value: {{ .Values.keda.hpa.scaleDown.policy.value }}
            periodSeconds: {{ .Values.keda.hpa.scaleDown.policy.periodSeconds }}
  {{- if or (and .Values.keda.trigger .Values.keda.trigger.metricName) .Values.keda.porterTriggers .Values.keda.triggers }}
  triggers:
  {{- if and .Values.keda.trigger .Values.keda.trigger.metricName }}
    - type: prometheus
      metricType: {{ .Values.keda.trigger.metricType | default "AverageValue" }}
      metadata:
        serverAddress: http://prometheus-server.monitoring.svc.cluster.local:80
        metricName: {{ .Values.keda.trigger.metricName }}
        query: {{ .Values.keda.trigger.metricQuery }}
        threshold: '{{ .Values.keda.trigger.metricThreshold }}'
        ignoreNullValues: {{ .Values.keda.trigger.ignoreNullValues | default "true" | quote }}
  {{- end }}
  {{- range .Values.keda.porterTriggers }}
    {{/* Porter-managed triggers: prefix authenticationRef.name with release name */}}
    {{- $authRef := .authenticationRef }}
    {{- $triggerCopy := omit . "authenticationRef" }}
    - {{- toYaml $triggerCopy | nindent 6 }}
      {{- if $authRef }}
      authenticationRef:
        name: {{ $fullName }}-{{ $authRef.name }}
      {{- end }}
  {{- end }}
  {{- range .Values.keda.triggers }}
    {{/* Raw KEDA triggers: pass through as-is */}}
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- end }}
{{- end }}